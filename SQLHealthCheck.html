<h2 style="padding-left: 35%;">SQL Database Health check in ASP.NET core</h2>

<p>In this article we will understand how to add a health check for SQL server database.</p>

<p>In this article we will create a .NET core web api. We will add a new api endpoint to add employee details to SQL server database.
    Then we will add a health check to check the connectivity of the SQL server database from the application. </p>

    <ol>
        <li>
            Create an asp.net core web api application.
            <p>
                <ul>
                    <li style="padding-bottom: 1%;">Open a new terminal in visual studio code</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/NewTerminal.png">
                    <li style="padding-bottom: 1%;">Navigate to the desired directory.</li>                    
                    <li style="padding-bottom: 1%;">Run the command "<i><b>dotnet new webapi</b></i>" to create the web api application</li>
                    <img style="padding-bottom: 1%;" width="500" height="200" src="./Images/HealthCheck/CreateWebAPI_App.png">
                </ul>
            </p>
        </li>
        <li>
            Create an Employee table in SQL database
            <p>
                <ul>
                    <li>Create a new table "Employee" in azure SQL database using the query <i>Create TABLE Employee (Id int PRIMARY KEY IDENTITY(1,1), FirstName nvarchar(50), LastName nvarchar(50))</i></li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/EmployeeTableDesign.png">

                    <li>Copy the connection string of the database from the azure portal</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/SQLDBConnectionString.png">
                </ul>
            </p>
        </li>
        <li>
            Create an Employee model class
            <p>
                <ul>
                    <li>Add a new folder named "Model" under the parent directory and add a new file named Employee.cs within the Model folder as shown below</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/AddEmployeeFile.png">

                    <li>Create an Employee class with first name and last name properties as shown below</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/AddPropertiesToEmployeeClass.png">
                </ul>
            </p>
        </li>
        <li>
            Create a new controller.
            <p>
                <ul>
                    <li>Create a new file within the Controller folder and name it as "DataController.cs" as shown below.</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/CreateDataController.png">

                    <li>Add a new class named DataController within the DataController.cs file within the namespace. Add the using statement as shown below </li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/InitialCode.png">                    
                                        
                    <li>Add a new api named "AddEmployee" which accepts an input parameter of type Employee class. Add "HttpPost", Route attribute as shown below </li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/APITemplate.png">

                    <li>Add code implementation to add new employee to sql employee database table. Install required nuget packages</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/CodeImplementation.png">
                </ul>                
            </p>
        </li>
        <li>
            Build and run the application. Invoke the api and add an employee.
            <p>
                <ul>
                    <li>Launch the swagger URL</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/SwaggerPage.png">

                    <li>Give first name and last name and click on submit. New Employee will be added to employee table </li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/APIResponse.png">

                    <li>Employee details in the employee table</li>
                    <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/EmployeeDataInDB.png">
                </ul>
            </p>
        </li>
    </ol>
        
    <p>Now we have an application which depends on SQL DB. This application is said to be helathy if the application can connect to SQL DB.
            Let's add a health check to verify the connectivity of the SQL DB
    </p>

    <ol>
        <li>We have a package "AspNetCore.HealthChecks.SqlServer" available to check the health of SQL server DB. Install the package</li>
        <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/SQLDBHealthCheckPackage.png">

        <li>Fetch the SQL DB connection string in the Program.cs file as shown below</li>
        <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/FetchSQLDBConnectionString.png">

        <li>Add SQL server health check using the "AddSqlServer" extension method as shown below </li>
        <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/AddSQLServerHealthCheck.png">

        <li>Add a health check endpoint in the Program.cs file</li>
        <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/MapHealthCheck.png">

        <li> Run the application and navigate to "Healthz" endpoint</li>
        <img style="padding-bottom: 1%;" width="600" height="250" src="./Images/HealthCheck/SQLHealthCheck/HealthCheckResult.png">
    </ol>



    